<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lahore City Navigator | Next-Gen</title>
    
    <!-- Leaflet & Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    
    <!-- Modern Font -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. GLOBAL STYLES (Dark Theme) --- */
        body { margin: 0; font-family: 'Montserrat', sans-serif; overflow: hidden; background: #121212; color: white; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* --- 2. GLASSMORPHISM SIDEBAR --- */
        #sidebar {
            position: absolute; top: 20px; left: 20px; bottom: 20px;
            width: 380px;
            /* The Frosted Glass Effect */
            background: rgba(30, 30, 30, 0.75);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            display: flex; flex-direction: column; overflow: hidden; z-index: 2000;
            transition: all 0.3s ease;
        }

        /* Controls Area */
        #controls { padding: 25px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        
       h2 { 
            margin: 0 0 20px 0; 
            font-size: 22px; 
            font-weight: 700; 
            color: #4facfe; /* Solid Neon Blue */
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .app-icon { width: 28px; height: 28px; filter: drop-shadow(0 0 5px rgba(79,172,254,0.6)); }

        /* Modern Inputs */
        .input-group { margin-bottom: 15px; position: relative; }
        .input-label { font-size: 11px; color: #aaa; font-weight: 600; margin-bottom: 6px; display: block; letter-spacing: 1px; }
        
        input[type="text"] { 
            width: 100%; padding: 14px; box-sizing: border-box;
            background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px; color: white; font-size: 14px; font-family: 'Montserrat', sans-serif;
            transition: 0.3s;
        }
        input[type="text"]:focus { 
            outline: none; border-color: #4facfe; 
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.2); transform: scale(1.01);
        }

        /* GPS Button */
        #gps-btn {
            background: none; border: none; cursor: pointer; font-size: 12px; 
            color: #4facfe; margin-bottom: 12px; display: flex; align-items: center; gap: 5px;
            transition: 0.3s;
        }
        #gps-btn:hover { color: #fff; text-shadow: 0 0 8px #4facfe; }

        /* Neon Search Button */
        button#find-btn {
            width: 100%; padding: 15px; margin-top: 10px;
            background: linear-gradient(90deg, #2980b9 0%, #2c3e50 100%);
            color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; 
            font-size: 14px; letter-spacing: 1px; text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(41, 128, 185, 0.4); transition: 0.3s;
        }
        button#find-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(41, 128, 185, 0.6); }
        button#find-btn:disabled { background: #555; cursor: not-allowed; transform: none; box-shadow: none; }

        /* Results Area */
        #results-area { flex: 1; padding: 20px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #555 transparent; }
        
        /* Route Cards */
        .route-card {
            background: rgba(255, 255, 255, 0.05); border-left: 5px solid #fff;
            border-radius: 8px; padding: 15px; margin-bottom: 15px;
            transition: 0.3s; cursor: pointer;
        }
        .route-card:hover { background: rgba(255, 255, 255, 0.1); transform: translateX(5px); }
        .route-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .dir-btn { 
            width: 100%; padding: 8px; margin-top: 10px; cursor: pointer; 
            background: rgba(255, 255, 255, 0.1); border: none; color: white; border-radius: 5px;
            transition: 0.2s;
        }
        .dir-btn:hover { background: rgba(255, 255, 255, 0.2); }

        /* Directions Modal */
        #directions-modal {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: #1a1a1a; z-index: 2001; transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); 
            display: flex; flex-direction: column;
        }
        #directions-modal.active { transform: translateX(0); }
        .dir-header { padding: 20px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center;}
        .close-btn { background: none; border: none; color: white; font-size: 28px; cursor: pointer; }
        #step-list { flex: 1; overflow-y: auto; padding: 0; margin: 0; list-style: none; }
        .step-item { padding: 15px 20px; border-bottom: 1px solid #333; font-size: 13px; color: #ccc; display: flex; align-items: center; gap: 10px; }
        .step-item b { color: white; }

        /* Hide Leaflet Default Controls for Cleaner Look */
        .leaflet-control-zoom { border: none !important; box-shadow: none !important; }
        .leaflet-bar a { background: rgba(0,0,0,0.8) !important; color: white !important; border: 1px solid #444 !important; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div id="controls">
            <h2>
                <img src="https://cdn-icons-png.flaticon.com/512/149/149060.png" class="app-icon">
                Lahore Navigator
            </h2>
            
            <button id="gps-btn" onclick="app.useGPS()">
                <span>üìç</span> Use My Current Location
            </button>

            <div class="input-group">
                <label class="input-label">STARTING POINT</label>
                <input type="text" id="start-input" list="locations-list" placeholder="Search landmark...">
            </div>

            <div class="input-group">
                <label class="input-label">DESTINATION</label>
                <input type="text" id="end-input" list="locations-list" placeholder="Search landmark...">
            </div>

            <datalist id="locations-list"></datalist>

            <button id="find-btn">Find Routes</button>
        </div>

        <div id="results-area">
            <div style="text-align:center; color:#666; margin-top:50px;">
                <img src="https://cdn-icons-png.flaticon.com/512/854/854878.png" width="60" style="opacity:0.2; margin-bottom:15px;">
                <br>
                <small>Select locations to calculate<br>optimized geometric paths.</small>
            </div>
        </div>

        <div id="directions-modal">
            <div class="dir-header">
                <span id="dir-title" style="font-weight:bold; color:#4facfe;">Directions</span>
                <button class="close-btn" id="close-dir-btn">√ó</button>
            </div>
            <ul id="step-list"></ul>
        </div>
    </div>

    <div id="map"></div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <script src="locations.js"></script>

    <script>
        // --- 1. Service Class (Logic) ---
        class RouteService {
            constructor(staticData) {
                this.db = staticData || [];
            }

            // O(N) Search for Local Data + API Fallback
            async getCoordinates(query) {
                // Check Local DB First
                const localMatch = this.db.find(l => l.name.toLowerCase() === query.toLowerCase());
                if (localMatch) return localMatch;

                // API Fallback
                try {
                    const q = encodeURIComponent(query + ", Lahore, Pakistan");
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`);
                    const data = await res.json();
                    if (data && data.length > 0) {
                        return { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), name: data[0].display_name.split(',')[0] };
                    }
                } catch (e) { console.error(e); }
                return null;
            }

            // Geometric Heuristic for Alternative Routes
            calculateMidpoints(start, end) {
                const midLat = (start.lat + end.lat) / 2;
                const midLon = (start.lon + end.lon) / 2;
                // Offset calculation to force path deviation
                return {
                    v1: L.latLng(midLat + 0.02, midLon + 0.02), // Route B (North-East pull)
                    v2: L.latLng(midLat - 0.02, midLon - 0.02)  // Route C (South-West pull)
                };
            }
        }

        // --- 2. Map Manager Class (Visuals) ---
        class MapManager {
            constructor(divId) {
                // Initialize Map centered on Lahore
                this.map = L.map(divId, {zoomControl: false}).setView([31.5204, 74.3587], 12);
                L.control.zoom({ position: 'topright' }).addTo(this.map);

                // DARK MODE LAYER (CartoDB Dark Matter)
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO',
                    maxZoom: 20
                }).addTo(this.map);

                this.markers = [];
                this.controls = [];
                this.carMarker = null;
                this.animationFrame = null;
            }

            addStaticDots(list) {
                list.forEach(l => {
                    L.circleMarker([l.lat, l.lon], {
                        radius: 3, color: '#4facfe', fillColor: '#00f2fe', fillOpacity: 0.8, weight: 0
                    }).addTo(this.map);
                });
            }

            resetMap() {
                this.markers.forEach(m => this.map.removeLayer(m));
                this.markers = [];
                this.controls.forEach(c => this.map.removeControl(c));
                this.controls = [];
                if(this.carMarker) this.map.removeLayer(this.carMarker);
                cancelAnimationFrame(this.animationFrame);
                document.querySelectorAll('.leaflet-routing-container').forEach(e => e.style.display='none');
            }

            addJourneyMarkers(start, end) {
                // Custom Icons
                const createIcon = (color) => L.divIcon({
                    className: 'custom-pin',
                    html: `<div style="background-color:${color};width:12px;height:12px;border-radius:50%;box-shadow:0 0 10px ${color};border:2px solid white;"></div>`
                });

                const s = L.marker([start.lat, start.lon], {icon: createIcon('#2ecc71')}).addTo(this.map).bindPopup("Start: "+start.name);
                const e = L.marker([end.lat, end.lon], {icon: createIcon('#e74c3c')}).addTo(this.map).bindPopup("End: "+end.name);
                this.markers.push(s, e);
            }

            // Draw Route & Start Car Animation
            drawRoute(start, end, ways, color, zoom, cb) {
                const pts = [L.latLng(start.lat,start.lon), ...ways, L.latLng(end.lat,end.lon)];
                
                const c = L.Routing.control({
                    waypoints: pts,
                    lineOptions: { styles: [{color: color, opacity: 0.8, weight: 5, className: 'neon-line'}] },
                    createMarker: () => null,
                    addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: zoom, show: false
                }).addTo(this.map);

                c.on('routesfound', (e) => {
                    this.controls.push(c);
                    document.querySelectorAll('.leaflet-routing-container').forEach(el => el.style.display='none');
                    
                    // If it's the recommended route, start animation
                    if(zoom) this.startCarAnimation(e.routes[0].coordinates);
                    
                    if(cb) cb(e.routes[0]);
                });
            }

            startCarAnimation(coords) {
                if(this.carMarker) this.map.removeLayer(this.carMarker);
                
                // Car Icon (Top Down View)
                const carIcon = L.icon({
                    iconUrl: 'https://cdn-icons-png.flaticon.com/512/3202/3202926.png',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });

                this.carMarker = L.marker([coords[0].lat, coords[0].lng], {icon: carIcon}).addTo(this.map);

                // Animation Loop
                let i = 0;
                const animate = () => {
                    if (i < coords.length) {
                        this.carMarker.setLatLng([coords[i].lat, coords[i].lng]);
                        // Rotate car logic can be added here, simplified for now
                        i += 2; // Speed Factor
                        this.animationFrame = requestAnimationFrame(animate);
                    }
                };
                animate();
            }
        }

        // --- 3. UI Manager Class (DOM) ---
        class UIManager {
            constructor() {
                this.store = {};
                this.sInput = document.getElementById('start-input');
                this.eInput = document.getElementById('end-input');
                this.btn = document.getElementById('find-btn');
                this.area = document.getElementById('results-area');
                this.modal = document.getElementById('directions-modal');
                document.getElementById('close-dir-btn').onclick = () => this.toggleModal(false);
            }

            fillDropdown(list) {
                const dl = document.getElementById('locations-list');
                list.sort((a,b)=>a.name.localeCompare(b.name));
                list.forEach(l => {
                    const opt = document.createElement('option');
                    opt.value = l.name;
                    dl.appendChild(opt);
                });
            }

            toggleLoading(active, msg="Calculating...") {
                this.btn.disabled = active;
                this.btn.innerHTML = active ? `<span class="spin">‚Üª</span> ${msg}` : "Find Routes";
                if(active) { this.area.innerHTML = ""; this.toggleModal(false); }
            }

            addCard(title, dist, time, color, steps) {
                this.store[color] = { title, steps };
                const div = document.createElement('div');
                div.className = 'route-card';
                div.style.borderLeftColor = color;
                div.innerHTML = `
                    <div class="route-header"><b style="color:${color}">${title}</b> <span style="font-size:12px; color:#fff;">${time}</span></div>
                    <div style="font-size:12px;color:#aaa">Distance: <b style="color:white">${dist}</b></div>
                    <button class="dir-btn" onclick="app.uiManager.showDetails('${color}')">View Instructions</button>
                `;
                this.area.appendChild(div);
            }

            showDetails(color) {
                const d = this.store[color];
                if(!d) return;
                document.getElementById('dir-title').innerText = d.title;
                const ul = document.getElementById('step-list');
                ul.innerHTML = "";
                d.steps.forEach(s => {
                    const li = document.createElement('li');
                    li.className = 'step-item';
                    li.innerHTML = `<span>‚ûî</span> <div>${s.text} <br><small style="color:#666">${Math.round(s.distance)} m</small></div>`;
                    ul.appendChild(li);
                });
                this.toggleModal(true);
            }

            toggleModal(show) {
                show ? this.modal.classList.add('active') : this.modal.classList.remove('active');
            }
        }

        // --- 4. Main App Controller ---
        class LahoreNavigator {
            constructor() {
                const data = (typeof mapLocations !== 'undefined') ? mapLocations : [];
                this.mapManager = new MapManager('map');
                this.uiManager = new UIManager();
                this.routeService = new RouteService(data);
                
                this.uiManager.fillDropdown(data);
                this.mapManager.addStaticDots(data);
                
                this.gpsLocation = null; // Store GPS coords

                document.getElementById('find-btn').onclick = () => this.start();
            }

            useGPS() {
                if(navigator.geolocation) {
                    this.uiManager.toggleLoading(true, "Locating GPS...");
                    navigator.geolocation.getCurrentPosition(
                        (pos) => {
                            this.gpsLocation = { lat: pos.coords.latitude, lon: pos.coords.longitude, name: "Current Location" };
                            document.getElementById('start-input').value = "üìç Current Location";
                            this.uiManager.toggleLoading(false);
                        },
                        () => { alert("GPS Access Denied"); this.uiManager.toggleLoading(false); }
                    );
                } else { alert("GPS not supported by browser."); }
            }

            async start() {
                const sVal = this.uiManager.sInput.value;
                const eVal = this.uiManager.eInput.value;
                
                if(!sVal || !eVal) return alert("Please fill both inputs");

                this.uiManager.toggleLoading(true);
                this.mapManager.resetMap();

                // 1. Resolve Start Location (Check if it's GPS or Text)
                let sLoc;
                if(sVal === "üìç Current Location" && this.gpsLocation) {
                    sLoc = this.gpsLocation;
                } else {
                    sLoc = await this.routeService.getCoordinates(sVal);
                }

                // 2. Resolve End Location
                const eLoc = await this.routeService.getCoordinates(eVal);

                if(!sLoc || !eLoc) {
                    this.uiManager.toggleLoading(false);
                    return alert("Address not found.");
                }

                // 3. Setup Map
                this.mapManager.addJourneyMarkers(sLoc, eLoc);
                const mids = this.routeService.calculateMidpoints(sLoc, eLoc);

                // 4. Fetch Routes (Recommended -> Alt 1 -> Alt 2)
                // Colors: Recommended(Neon Purple), Alt1(Blue), Alt2(Orange)
                this.fetchRoute(sLoc, eLoc, [], '#b33dc6', 'Recommended Route', true, () => {
                    this.fetchRoute(sLoc, eLoc, [mids.v1], '#4facfe', 'Ring Road Alternative', false, () => {
                        this.fetchRoute(sLoc, eLoc, [mids.v2], '#f0932b', 'City Center Alternative', false, () => {
                            this.uiManager.toggleLoading(false);
                        });
                    });
                });
            }

            fetchRoute(start, end, ways, color, label, zoom, next) {
                this.mapManager.drawRoute(start, end, ways, color, zoom, (route) => {
                    if(route) {
                        const d = (route.summary.totalDistance/1000).toFixed(1)+" km";
                        const t = Math.round(route.summary.totalTime/60)+" min";
                        this.uiManager.addCard(label, d, t, color, route.instructions);
                    }
                    if(next) setTimeout(next, 600);
                });
            }
        }

        // Start Application
        let app; 
        window.onload = () => { app = new LahoreNavigator(); };

    </script>
</body>
</html>